<div
  class="details-navbar-fixed d-flex align-items-center gap-12 p-y-12 p-x-16 b-1 bg-white"
>
  <button
    mat-icon-button
    class="bg-primary text-white"
    (click)="getBack()"
    aria-label="Volver"
  >
    <mat-icon>arrow_back</mat-icon>
  </button>
  <!-- Título pequeño removido: usaremos solo el título grande dentro de la tarjeta -->
  <ng-template #loadingTitle
    ><span class="f-s-14 text-muted">Cargando...</span></ng-template
  >
</div>
<div class="details-wrapper p-16 p-sm-0 m-t-navbar-details">
  @if(loading){
  <div class="skeleton-wrapper">
    <div class="row">
      <div class="col-lg-6 m-b-20">
        <div class="skeleton skeleton-img w-100"></div>
      </div>
      <div class="col-lg-6">
        <div class="skeleton skeleton-badge m-b-12"></div>
        <div class="skeleton skeleton-title m-b-16"></div>
        <div class="skeleton skeleton-text m-b-8"></div>
        <div class="skeleton skeleton-text m-b-8 w-80"></div>
        <div class="skeleton skeleton-price m-b-24"></div>
        <div class="d-flex gap-10 m-b-24">
          <div class="skeleton skeleton-btn"></div>
          <div class="skeleton skeleton-btn"></div>
        </div>
      </div>
    </div>
    <div class="skeleton skeleton-tab m-b-24"></div>
    <div class="row">
      @for(i of [1,2,3,4]; track i){
      <div class="col-sm-6 col-lg-3 m-b-16 p-0">
        <div class="skeleton skeleton-card w-100"></div>
      </div>
      }
    </div>
  </div>
  } @else {
  <!-- Botón volver reemplazado por navbar fijo -->
  }
  <mat-card class="cardWithShadow b-1 rounded p-30 details-card">
    <div class="row">
      <div
        class="col-lg-1 m-r-20 thumbs-column"
        role="tablist"
        aria-label="Galería de imágenes del producto"
        *ngIf="slides.length > 0"
      >
        @for(slide of slides; let i = $index; track slide.id){
        <button
          type="button"
          class="thumb-btn p-0"
          (click)="goToSlide(i)"
          [attr.aria-label]="'Imagen ' + (i + 1)"
          role="tab"
          [attr.aria-selected]="i === activeIndex"
          [attr.data-index]="i"
          [attr.data-active]="i === activeIndex ? 'true' : null"
        >
          <div class="thumb-wrapper" [class.active]="i === activeIndex">
            <img
              [src]="slide.imgUrl"
              [alt]="slide.altText"
              class="thumb-img"
              [attr.data-index]="i"
              [attr.data-active]="i === activeIndex ? 'true' : null"
            />
          </div>
        </button>
        }
      </div>
      <div class="col-lg-6">
        @if(slides.length > 0){
        <owl-carousel-o [options]="customOptions" class="product-carousel">
          @for(slide of slides; track slide.id){
          <ng-template carouselSlide [id]="slide.id">
            <img
              [src]="slide.imgUrl"
              [alt]="slide.altText"
              class="rounded w-100"
              (error)="slide.imgUrl = 'assets/images/products/no-image.png'"
              [class.active]="activeIndex === +slide.id"
              [attr.data-index]="slide.id"
              [attr.data-active]="activeIndex === +slide.id ? 'true' : null"
            />
          </ng-template>
          }
        </owl-carousel-o>
        }@else {
        <img
          [src]="product?.imagePath || 'assets/images/products/no-image.png'"
          alt="producto"
          class="rounded w-100"
          (error)="onImgError($event)"
        />
        }
      </div>
      <div class="col-lg-4">
        <!-- Chips de estado y categoría removidos temporalmente -->
        <h3 class="m-t-10 f-w-600">{{ product?.product_name }}</h3>
        @if(vendor){
        <div class="f-s-14 m-t-4">
          Vendedor: <span class="f-w-600">{{ vendor.name }}</span>
        </div>
        }
        <p class="m-t-1 f-s-14 f-w-500">
          {{
            product?.description ||
              product?.desc ||
              "Descripción no disponible."
          }}
        </p>
        <div class="f-s-14 m-t-8 wholesale-extra">
          @if(product?.talles){
          <div class="line d-flex align-items-center gap-4 m-b-4">
            <i-tabler name="ruler" class="icon-14 text-muted"></i-tabler
            ><strong>Talles:</strong>
            <span class="talles-badge">{{ product?.talles }}</span>
          </div>
          } @if(product?.tela){
          <div class="line d-flex align-items-center gap-4 m-b-4">
            <i-tabler name="scissors" class="icon-14 text-muted"></i-tabler
            ><strong>Tela:</strong> {{ product?.tela }}
          </div>
          } @if(product?.generos?.length){
          <div class="line d-flex align-items-center gap-4 m-b-4">
            <i-tabler name="users" class="icon-14 text-muted"></i-tabler>
            <strong>Géneros:</strong>
            <span class="chip-wrapper d-flex flex-wrap gap-4">
              @for(g of product?.generos; track g){
              <span class="category-chip genero-chip">{{ g }}</span>
              }
            </span>
          </div>
          } @if(product?.salesType){
          <div class="line d-flex align-items-center gap-4 m-b-4">
            <i-tabler name="cash" class="icon-14 text-muted"></i-tabler>
            <strong>Tipo de venta:</strong>
            <span class="category-chip">{{ product?.salesType }}</span>
          </div>
          } @if(product?.categoria){
          <div class="line d-flex align-items-center gap-4">
            <i-tabler name="tag" class="icon-14 text-muted"></i-tabler
            ><strong>Categoría:</strong>
            <span class="category-chip">{{ product?.categoria }}</span>
          </div>
          }
        </div>
        <div
          class="d-flex align-items-center price-block m-t-4"
          *ngIf="product as p"
        >
          <ng-container
            *ngIf="
              p.dealPrice !== undefined &&
                p.base_price !== undefined &&
                p.dealPrice < p.base_price;
              else baseOnly
            "
          >
            <span
              class="price-old f-s-16 f-w-600 m-r-8 text-muted"
              aria-label="Precio anterior"
              >{{ p.base_price | monedaARS }}</span
            >
            <span
              class="f-s-20 f-w-600 text-success"
              aria-label="Precio con descuento"
              >{{ p.dealPrice | monedaARS }}</span
            >
            <span class="discount-badge f-s-14 f-w-600 m-l-8"
              >{{
                p.discountPercent ||
                  ((p.base_price - p.dealPrice) / p.base_price) * 100
                  | number : "1.0-0"
              }}% OFF</span
            >
          </ng-container>
          <ng-template #baseOnly>
            <span class="f-s-20 f-w-600 text-primary">{{
              p?.base_price | monedaARS
            }}</span>
          </ng-template>
        </div>
        <div class="m-y-24 d-flex">
          <!-- Estrellas removidas -->
        </div>
        <mat-divider></mat-divider>
        <div class="colors-block m-t-16" *ngIf="colorSwatches.length || product?.color">
          <label class="f-s-16 f-w-600 m-b-8 d-block">Colores disponibles</label>
          <div class="color-chips">
            @for(c of colorSwatches; track c.hex){
            <button type="button" class="color-chip" [class.selected]="c.name === selectedColorName" (click)="setSelectedColor(c)" [title]="c.name">
              <span class="swatch" [style.background]="c.hex"></span>
              <span class="color-name">{{ c.name }}</span>
            </button>
            }
            @if(!colorSwatches.length && product?.color){
            <div class="color-chip legacy" [title]="product.color">
              <span class="swatch" [style.background]="product.color"></span>
              <span class="color-name">{{ product.color }}</span>
            </div>
            }
          </div>
          <div class="selected-color-label" *ngIf="selectedColorName">Color seleccionado: <strong>{{ selectedColorName }}</strong></div>
        </div>
        <div class="d-flex align-items-center m-b-30">
          <label class="f-s-16 f-w-600">Cant:</label>
          <mat-button-toggle-group
            #toggleGroup="matButtonToggleGroup"
            class="border-style m-x-20"
            [(value)]="toggleValue"
            multiple
          >
            <mat-button-toggle
              (click)="decreaseQty(); toggleGroup.value = null"
              disableRipple
              >-</mat-button-toggle
            >
            <mat-button-toggle disableRipple>{{ quantity }}</mat-button-toggle>
            <mat-button-toggle
              (click)="increaseQty(); toggleGroup.value = null"
              disableRipple
              >+</mat-button-toggle
            >
          </mat-button-toggle-group>
        </div>
        <mat-divider></mat-divider>
        <div class="d-flex align-items-center m-y-20">
          <!-- Botón de agregar al carrito -->
          <button
            mat-flat-button
            color="primary"
            class="add-to-cart-btn"
            (click)="addToCart()"
          >
            <div class="d-flex align-items-center">
              <i-tabler name="shopping-cart" class="icon-18 m-r-6"></i-tabler>
              <span>Agregar al carrito</span>
            </div>
          </button>
        </div>
        <p class="m-t-10">
          Despachado en 2–3 semanas<br />
          <a href="#" class="text-primary text-decoration-none f-s-14 f-w-500"
            >¿Por qué el tiempo de entrega es mayor?</a
          >
        </p>
      </div>
    </div>
  </mat-card>
  <mat-card class="cardWithShadow b-1 rounded p-30 details-card">
    <mat-tab-group
      mat-stretch-tabs="false"
      mat-align-tabs="start"
      [(selectedIndex)]="selectedTabIndex"
    >
      <mat-tab>
        <ng-template mat-tab-label
          ><span [class.text-primary]="selectedTabIndex === 0"
            >Descripción</span
          ></ng-template
        >
        <div class="m-t-20">
          <p class="f-s-14 f-w-400 m-0" style="white-space: pre-line">
            {{
              product?.description ||
                product?.desc ||
                "Descripción no disponible."
            }}
          </p>
        </div>
      </mat-tab>
      <!--
    <mat-tab>
      <ng-template mat-tab-label><span [class.text-primary]="selectedTabIndex === 1">Reseñas</span></ng-template>
      <div class="row m-t-24 gap-0 w-100" >
        <div class="col-lg-4 d-flex">
          <mat-card class="cardWithShadow b-1 rounded w-100 h-80 d-flex justify-content-center align-items-center">
            <div class="text-center">
              <h6 class="f-s-14 f-w-500">Calificación promedio</h6>
              <h6 class="text-primary f-s-30 f-w-600 m-y-24">4/5</h6>
              <div class="d-flex gap-5">
                <span><i-tabler name="star" class="fill-warning icon-18"></i-tabler></span>
                <span><i-tabler name="star" class="fill-warning icon-18"></i-tabler></span>
                <span><i-tabler name="star" class="fill-warning icon-18"></i-tabler></span>
                <span><i-tabler name="star" class="fill-warning icon-18"></i-tabler></span>
                <span><i-tabler name="star" class="icon-18"></i-tabler></span>
              </div>
            </div>
          </mat-card>
        </div>
        <div class="col-lg-4 d-flex">
          <mat-card class="cardWithShadow b-1 rounded w-100 h-80 p-20">
            @for(rating of ratings; track rating) {
            <div class="d-flex align-items-center gap-1 m-t-10">
              <span class="f-s-14 w-60">{{ rating.label }} Stars</span>
              <mat-progress-bar class="progress rounded w-20 m-x-24 m-y-10" color="primary" mode="determinate" [value]="rating.value"></mat-progress-bar>
              <span class="count">({{ rating.count }})</span>
            </div>
            }
          </mat-card>
        </div>
        <div class="col-lg-4 d-flex">
          <mat-card class="cardWithShadow b-1 rounded w-100 h-80 d-flex align-items-center justify-content-center">
            <button mat-stroked-button class="w-75 bg-light-primary">
              <div class="d-flex align-items-center justify-content-center">
                <tabler-icon name="pencil" class="m-x-6"></tabler-icon>
                <span>Escribir una reseña</span>
              </div>
            </button>
          </mat-card>
        </div>
      </div>
    </mat-tab>
    -->
    </mat-tab-group>
  </mat-card>
</div>
